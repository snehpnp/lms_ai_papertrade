// TradeLearn Pro - Prisma Schema
// PostgreSQL + modular entities

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  ADMIN
  SUBADMIN
  USER
}

enum LessonType {
  VIDEO
  PDF
  TEXT
  QUIZ
}

enum ExerciseType {
  MCQ
  FILL_IN_BLANKS
}

enum OrderSide {
  BUY
  SELL
}

enum OrderStatus {
  PENDING
  FILLED
  CANCELLED
  REJECTED
}

enum PositionStatus {
  OPEN
  CLOSED
}

enum WalletTransactionType {
  CREDIT
  DEBIT
  TRADE_PNL
  REFUND
  COMMISSION
}

enum PaymentProvider {
  RAZORPAY
  STRIPE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// ============ USER & AUTH ============

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          Role      @default(USER)
  isBlocked     Boolean   @default(false) @map("is_blocked")
  referralCode  String    @unique @map("referral_code")
  referredById  String?   @map("referred_by_id")
  referredBy    User?     @relation("Referrals", fields: [referredById], references: [id])
  referredUsers User[]    @relation("Referrals")
  referralSignupBonusAmount Decimal? @map("referral_signup_bonus_amount") @db.Decimal(15, 2) // Virtual balance given to new users who register with this referrer's code (Admin/Subadmin only)
  emailVerified Boolean   @default(false) @map("email_verified")
  resetTokenHash String?  @map("reset_token_hash")
  resetTokenExp  DateTime? @map("reset_token_exp")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  refreshTokens   RefreshToken[]
  wallet          Wallet?
  wishlist        WishlistItem[]
  enrollments     Enrollment[]
  trades          Trade[]
  positions       Position[]
  orders          Order[]
  activityLogs    ActivityLog[]
  commissions     Commission[]       @relation("EarnedCommissions")
  subadminCourses Course[]           @relation("SubadminCourses")
  payments        Payment[]
  certificates    Certificate[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  @@index([userId])
  @@index([tokenHash])
}

// ============ COURSE & LMS ============

model Course {
  id          String    @id @default(uuid())
  title       String
  description String?   @db.Text
  slug        String    @unique
  thumbnail   String?
  price       Decimal   @db.Decimal(10, 2) @default(0)
  isPublished Boolean   @default(false) @map("is_published")
  subadminId  String?   @map("subadmin_id")
  subadmin    User?     @relation("SubadminCourses", fields: [subadminId], references: [id], onDelete: SetNull)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  modules    Module[]
  enrollments Enrollment[]
  exercises   Exercise[]  @relation("CourseExercises")
  payments   Payment[]
  @@index([subadminId])
  @@index([isPublished])
  @@index([slug])
}

model Module {
  id        String   @id @default(uuid())
  courseId  String   @map("course_id")
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title     String
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  lessons Lesson[]
  @@index([courseId])
}

model Lesson {
  id        String     @id @default(uuid())
  moduleId  String     @map("module_id")
  module    Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title     String
  type      LessonType
  content   String?    @db.Text
  videoUrl  String?    @map("video_url")
  pdfUrl    String?    @map("pdf_url")
  order     Int        @default(0)
  duration  Int?       // seconds
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  exercises Exercise[] @relation("LessonExercises")
  progress  Progress[]
  @@index([moduleId])
}

model Exercise {
  id         String       @id @default(uuid())
  type       ExerciseType
  question   String       @db.Text
  options    Json?        // MCQ: [{ id, text, isCorrect }]
  answer     String?      @db.Text // Fill in blanks: JSON array of answers
  lessonId   String?      @map("lesson_id")
  lesson     Lesson?      @relation("LessonExercises", fields: [lessonId], references: [id], onDelete: Cascade)
  courseId   String?      @map("course_id")
  course     Course?      @relation("CourseExercises", fields: [courseId], references: [id], onDelete: Cascade)
  order      Int          @default(0)
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  submissions ExerciseSubmission[]
  @@index([lessonId])
  @@index([courseId])
}

model Enrollment {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String    @map("course_id")
  course    Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrolledAt DateTime @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")

  progress   Progress[]
  certificate Certificate?
  submissions ExerciseSubmission[]
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Progress {
  id           String    @id @default(uuid())
  enrollmentId String   @map("enrollment_id")
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonId     String   @map("lesson_id")
  lesson       Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  completedAt  DateTime @default(now()) @map("completed_at")
  timeSpent    Int      @default(0) @map("time_spent") // seconds

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
}

model ExerciseSubmission {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  exerciseId   String    @map("exercise_id")
  exercise     Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  enrollmentId String    @map("enrollment_id")
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  response     Json      // selected option(s) or fill-in answers
  isCorrect    Boolean   @map("is_correct")
  score        Decimal   @db.Decimal(5, 2) @default(0)
  submittedAt  DateTime  @default(now()) @map("submitted_at")

  @@index([userId])
  @@index([exerciseId])
  @@index([enrollmentId])
}

model Certificate {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollmentId String    @unique @map("enrollment_id")
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  issuedAt     DateTime  @default(now()) @map("issued_at")
  pdfUrl       String?   @map("pdf_url")

  @@index([userId])
}

// ============ WALLET ============

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance   Decimal  @db.Decimal(15, 2) @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  transactions WalletTransaction[]
}

model WalletTransaction {
  id          String                @id @default(uuid())
  walletId    String                @map("wallet_id")
  wallet      Wallet                @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type        WalletTransactionType
  amount      Decimal               @db.Decimal(15, 2)
  balanceAfter Decimal?             @map("balance_after") @db.Decimal(15, 2)
  reference   String?               // trade id, payment id, etc.
  description String?               @db.Text
  createdAt   DateTime              @default(now()) @map("created_at")

  @@index([walletId])
  @@index([createdAt])
}

model WishlistItem {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol    String
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, symbol])
  @@index([userId])
}

// ============ TRADING ============

model Trade {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId     String   @map("order_id")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  symbol      String
  side        OrderSide
  quantity    Decimal  @db.Decimal(18, 8)
  price       Decimal  @db.Decimal(18, 8)
  brokerage   Decimal  @db.Decimal(18, 8) @default(0)
  pnl         Decimal? @db.Decimal(18, 8)
  positionId  String?  @map("position_id")
  position    Position? @relation(fields: [positionId], references: [id], onDelete: SetNull)
  executedAt  DateTime @default(now()) @map("executed_at")

  @@index([userId])
  @@index([symbol])
  @@index([executedAt])
  @@index([orderId])
  @@index([positionId])
}

model Position {
  id          String         @id @default(uuid())
  userId      String         @map("user_id")
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol      String
  side        OrderSide
  quantity    Decimal        @db.Decimal(18, 8)
  avgPrice    Decimal        @map("avg_price") @db.Decimal(18, 8)
  currentPrice Decimal?      @map("current_price") @db.Decimal(18, 8)
  unrealizedPnl Decimal?    @map("unrealized_pnl") @db.Decimal(18, 8)
  status      PositionStatus @default(OPEN)
  openedAt    DateTime       @default(now()) @map("opened_at")
  closedAt    DateTime?      @map("closed_at")

  trades      Trade[]
  @@index([userId])
  @@index([userId, symbol, status])
  @@index([status])
}

model Order {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol      String
  side        OrderSide
  quantity    Decimal     @db.Decimal(18, 8)
  price       Decimal?    @db.Decimal(18, 8) // null for market
  orderType   String      @map("order_type") // MARKET, LIMIT
  status      OrderStatus @default(PENDING)
  filledQty   Decimal     @default(0) @map("filled_qty") @db.Decimal(18, 8)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  trades Trade[]
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============ MARKET / BROKERAGE CONFIG ============

model MarketConfig {
  id            String   @id @default(uuid())
  symbol        String   @unique
  name          String?
  lotSize       Decimal  @map("lot_size") @db.Decimal(18, 8) @default(1)
  tickSize      Decimal  @map("tick_size") @db.Decimal(18, 8) @default(0.01)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
}

model BrokerageConfig {
  id        String   @id @default(uuid())
  type      String   // PERCENTAGE, FIXED
  value     Decimal  @db.Decimal(10, 4)
  minCharge Decimal? @map("min_charge") @db.Decimal(10, 2)
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

// ============ REFERRAL & COMMISSION ============

model Referral {
  id          String   @id @default(uuid())
  referrerId  String   @map("referrer_id")
  referredId  String   @unique @map("referred_id")
  code        String
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([referrerId])
}

model Commission {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation("EarnedCommissions", fields: [userId], references: [id], onDelete: Cascade)
  paymentId   String   @map("payment_id")
  payment     Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  amount      Decimal  @db.Decimal(10, 2)
  percentage  Decimal  @db.Decimal(5, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([paymentId])
}

// ============ PAYMENT ============

model Payment {
  id            String          @id @default(uuid())
  userId        String          @map("user_id")
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId      String?         @map("course_id")
  course        Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull)
  amount        Decimal         @db.Decimal(10, 2)
  currency      String          @default("INR")
  provider      PaymentProvider
  providerOrderId String?       @map("provider_order_id")
  providerPaymentId String?    @map("provider_payment_id")
  status        PaymentStatus   @default(PENDING)
  metadata      Json?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  commissions Commission[]
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([providerOrderId])
}

// ============ ACTIVITY & REPORTS ============

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String
  resource  String?
  details   Json?
  ip        String?
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

// Leaderboard can be computed from Trade/Position; optional cache table
model LeaderboardSnapshot {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  netProfitPct Decimal @map("net_profit_pct") @db.Decimal(10, 4)
  winRate   Decimal  @map("win_rate") @db.Decimal(5, 2)
  tradeCount Int     @map("trade_count")
  snapshotAt DateTime @default(now()) @map("snapshot_at")

  @@index([snapshotAt])
  @@index([userId])
}
